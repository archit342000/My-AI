<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My AI | Logs Browser</title>
    <link rel="icon" media="(prefers-color-scheme: light)" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop offset='0' stop-color='%234F46E5'/><stop offset='1' stop-color='%2306B6D4'/></linearGradient></defs><path d='M16 2L26 12L16 30L6 12Z' fill='url(%23g)'/><path d='M16 2L26 12H6Z' fill='white' opacity='0.25'/><circle cx='16' cy='12' r='2.5' fill='white' opacity='0.9'/></svg>">
    <link rel="icon" media="(prefers-color-scheme: dark)" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop offset='0' stop-color='%236366F1'/><stop offset='1' stop-color='%2322D3EE'/></linearGradient></defs><path d='M16 2L26 12L16 30L6 12Z' fill='url(%23g)'/><path d='M16 2L26 12H6Z' fill='white' opacity='0.3'/><circle cx='16' cy='12' r='2.5' fill='white'/></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0d1117;
            --sidebar-bg: #161b22;
            --border: #30363d;
            --text: #c9d1d9;
            --text-dim: #8b949e;
            --accent: #58a6ff;
            --llm-tag: #238636;
            --tool-tag: #9e6a03;
            --hover: #21262d;
            --font-family: 'Outfit', -apple-system, sans-serif;
            --font-mono: 'Fira Code', monospace;
        }

        body {
            margin: 0;
            padding: 0;
            background: var(--bg);
            color: var(--text);
            font-family: var(--font-family);
            display: grid;
            grid-template-columns: 350px 1fr;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar - Log List */
        .sidebar {
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-header h2 {
            margin: 0;
            font-size: 1.2rem;
            color: var(--text);
        }

        .tabs {
            display: flex;
            gap: 10px;
            padding: 10px 20px;
            border-bottom: 1px solid var(--border);
        }

        .tab {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            border: 1px solid transparent;
            color: var(--text-dim);
            transition: 0.2s;
        }

        .tab.active {
            background: var(--bg);
            border-color: var(--border);
            color: var(--accent);
        }

        .log-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .log-item {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            border: 1px solid transparent;
            transition: 0.2s;
        }

        .log-item:hover {
            background: var(--hover);
        }

        .log-item.active {
            background: var(--hover);
            border-color: var(--accent);
        }

        .log-meta {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        .category-tag {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            text-transform: uppercase;
            font-weight: 600;
        }

        .cat-llm { background: rgba(35, 134, 54, 0.2); color: #3fb950; }
        .cat-tool { background: rgba(158, 106, 3, 0.2); color: #d29922; }

        .log-title {
            font-weight: 500;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .log-time { font-family: 'Fira Code', monospace; }

        /* Detail View */
        .detail-view {
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--bg);
        }

        .detail-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .detail-content {
            flex: 1;
            overflow: auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .json-section {
            background: #010409;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }

        .section-label {
            font-size: 0.75rem;
            color: var(--accent);
            text-transform: uppercase;
            margin-bottom: 10px;
            font-weight: 600;
            letter-spacing: 0.05em;
        }

        pre {
            margin: 0;
            font-family: 'Fira Code', monospace;
            font-size: 0.85rem;
            line-height: 1.5;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-dim);
        }

        /* Event Log Style */
        .event-item {
            padding: 10px;
            border-bottom: 1px solid var(--border);
            font-size: 0.85rem;
        }
        .event-type {
            color: var(--accent);
            font-weight: 600;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>Network Logs</h2>
            <button onclick="loadLogs()" style="background:none; border:none; color:var(--accent); cursor:pointer; font-size:0.8rem;">Refresh</button>
        </div>
        <div class="tabs">
            <div class="tab active" id="tab-network" onclick="switchMode('network')">Network</div>
            <div class="tab" id="tab-events" onclick="switchMode('events')">Events</div>
        </div>
        <div class="log-list" id="log-list">
            <!-- Logs injected here -->
        </div>
    </div>

    <div class="detail-view" id="detail-view">
        <div class="empty-state">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"></path>
            </svg>
            <p>Select a log to view details</p>
        </div>
    </div>

    <script>
        let currentMode = 'network';
        let currentLogs = [];

        async function loadLogs() {
            const listDiv = document.getElementById('log-list');
            listDiv.innerHTML = '<div class="empty-state">Loading...</div>';
            
            try {
                const endpoint = currentMode === 'network' ? '/api/logs' : '/api/logs/events';
                const res = await fetch(endpoint);
                currentLogs = await res.json();
                renderList();
            } catch (err) {
                listDiv.innerHTML = '<div class="empty-state">Failed to load logs</div>';
            }
        }

        function switchMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${mode}`).classList.add('active');
            loadLogs();
            document.getElementById('detail-view').innerHTML = '<div class="empty-state"><p>Select a log to view details</p></div>';
        }

        function renderList() {
            const listDiv = document.getElementById('log-list');
            listDiv.innerHTML = '';
            
            if (currentLogs.length === 0) {
                listDiv.innerHTML = '<div class="empty-state">No logs found</div>';
                return;
            }

            currentLogs.forEach((log, index) => {
                if (currentMode === 'network') {
                    const item = document.createElement('div');
                    item.className = 'log-item';
                    item.onclick = () => showDetail(log, item);
                    
                    const time = new Date(log.timestamp).toLocaleTimeString();
                    const date = new Date(log.timestamp).toLocaleDateString();
                    
                    item.innerHTML = `
                        <div class="log-meta">
                            <span class="category-tag cat-${log.category}">${log.category}</span>
                            <span class="log-time">${date} ${time}</span>
                        </div>
                        <div class="log-title">${log.model_tool}</div>
                        <div style="font-size:0.75rem; color:var(--text-dim); margin-top:4px;">${log.type || 'blocking'}</div>
                    `;
                    listDiv.appendChild(item);
                } else {
                    const item = document.createElement('div');
                    item.className = 'event-item';
                    item.innerHTML = `
                        <div class="log-meta">
                            <span class="log-time">${new Date(log.timestamp).toLocaleTimeString()}</span>
                        </div>
                        <div><span class="event-type">${log.type}</span></div>
                        <div style="margin-top:5px; color:var(--text-dim)">${JSON.stringify(log.data)}</div>
                    `;
                    listDiv.appendChild(item);
                }
            });
        }

        function escapeHtml(text) {
            if (typeof text !== 'string') return text;
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function showDetail(log, element) {
            document.querySelectorAll('.log-item').forEach(i => i.classList.remove('active'));
            element.classList.add('active');

            const detailView = document.getElementById('detail-view');
            detailView.innerHTML = '<div class="empty-state">Loading detail...</div>';

            try {
                const res = await fetch(`/api/logs/detail?path=${encodeURIComponent(log.log_file)}`);
                const fullLog = await res.json();
                
                const requestJson = JSON.stringify(fullLog.request, null, 2);
                
                // If the response is a string (common for LLM), we want to preserve things like <think>
                // If it's an object (common for tool calls), we stringify it.
                let responseView = "";
                if (typeof fullLog.response === 'string') {
                    responseView = escapeHtml(fullLog.response);
                } else {
                    responseView = escapeHtml(JSON.stringify(fullLog.response, null, 2));
                }

                detailView.innerHTML = `
                    <div class="detail-header">
                        <div>
                            <h2 style="margin:0; font-size:1.2rem;">${escapeHtml(log.model_tool)}</h2>
                            <p style="margin:5px 0 0 0; font-size:0.8rem; color:var(--text-dim); font-family:'Fira Code'">${fullLog.timestamp}</p>
                        </div>
                        <div style="text-align:right">
                            <span class="category-tag cat-${log.category}">${log.category}</span>
                            <div style="font-size:0.8rem; color:var(--text-dim); margin-top:5px;">Duration: ${fullLog.duration_s}s</div>
                        </div>
                    </div>
                    <div class="detail-content">
                        <div class="json-section">
                            <div class="section-label">Request Payload</div>
                            <pre>${escapeHtml(requestJson)}</pre>
                        </div>
                        <div class="json-section">
                            <div class="section-label">Response Data</div>
                            <pre>${responseView}</pre>
                        </div>
                    </div>
                `;
            } catch (err) {
                detailView.innerHTML = '<div class="empty-state">Failed to load log detail</div>';
            }
        }

        // Initial load
        loadLogs();
    </script>
</body>
</html>
